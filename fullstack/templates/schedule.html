<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Schedule Maker â€” Week View</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-height: 100vh;
        }

        aside {
            width: 300px;
            background: #fff;
            padding: 1rem;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        main {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        h1 {
            text-align: center;
            margin-top: 0;
        }

        .filters label {
            display: block;
            margin-top: 1rem;
            font-weight: bold;
        }

        .filters input,
        .filters select,
        .filters button {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            box-sizing: border-box;
        }

        .calendar {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            grid-template-rows: 40px repeat(15, 60px);
            gap: 0;
            border: 1px solid #ccc;
            background: #fff;
            max-width: 1000px;
            margin: 1rem auto;
            width: 100%;
            box-sizing: border-box;
        }

        .day-header {
            background: #f0f4f8;
            text-align: center;
            font-weight: bold;
            border-left: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-label {
            text-align: right;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #666;
            border-top: 1px solid #eee;
            border-right: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .cell {
            border-top: 1px solid #eee;
            border-left: 1px solid #eee;
        }

        .event {
            background: #4a90e2;
            color: white;
            padding: 0.3rem;
            margin: 1px;
            font-size: 0.8rem;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        .sections-list {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .sections-list h2 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .sections-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sections-list li {
            border-bottom: 1px solid #eee;
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sections-list li:last-child {
            border-bottom: none;
        }

        .sections-list span {
            margin-right: 1rem;
        }

        .sections-list .enroll-button,
        .sections-list .drop-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9rem;
        }

        .sections-list .enroll-button {
            background-color: #4CAF50;
            color: white;
        }

        .sections-list .enroll-button:hover {
            background-color: #45a049;
        }

        .sections-list .drop-button {
            background-color: #f44336;
            color: white;
        }

        .sections-list .drop-button:hover {
            background-color: #d32f2f;
        }

        .enrolled-section {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .enrolled-section .drop-button {
            background-color: #f44336;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.7rem;
        }

        .enrolled-section .drop-button:hover {
            background-color: #d32f2f;
        }

        @media (max-width: 768px) {
            .calendar {
                grid-template-columns: 60px repeat(7, 1fr);
                grid-template-rows: 30px repeat(15, 50px);
            }

            .day-header {
                font-size: 0.8em;
            }

            .time-label {
                font-size: 0.6em;
            }

            .event {
                font-size: 0.7em;
                padding: 0.2rem;
            }

            aside {
                width: 100%;
                position: relative;
                height: auto;
                overflow-y: visible;
            }

            main {
                padding: 1rem;
            }

            .filters {
                margin-bottom: 1rem;
            }

            .sections-list .enroll-button,
            .sections-list .drop-button {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <aside>
        <h2>Filter Sections</h2>
        <form method="get" class="filters" action="{{ url_for('schedule') }}">
            <label for="p_department">Department</label>
            <input id="p_department" name="p_department"
                   value="{{ filters.get('p_department','') }}">

            <label for="p_courseID">Course ID</label>
            <input id="p_courseID" name="p_courseID"
                   value="{{ filters.get('p_courseID','') }}">

            <label for="p_professor">Professor</label>
            <input id="p_professor" name="p_professor"
                   value="{{ filters.get('p_professor','') }}">

            <label for="p_min_credits">Min Credits</label>
            <input type="number" id="p_min_credits" name="p_min_credits"
                   value="{{ filters.get('p_min_credits','') }}">

            <label for="p_max_credits">Max Credits</label>
            <input type="number" id="p_max_credits" name="p_max_credits"
                   value="{{ filters.get('p_max_credits','') }}">

            <label for="p_campus_available">Campus</label>
            <select id="p_campus_available" name="p_campus_available">
                <option value="">Any</option>
                {% for c in campuses %}
                    <option value="{{ c }}"
                      {% if filters.get('p_campus_available','') == c %}selected{% endif %}>
                      {{ c }}
                    </option>
                {% endfor %}
            </select>

            <button type="submit">Search</button>
            <button type="reset" onclick="location='?';">Clear</button>
        </form>
    </aside>

    <main>
        <h1>My Weekly Schedule</h1>
        <div class="calendar" id="calendar"></div>

        <div class="sections-list">
            <h2>Available Sections</h2>
            <ul>
                {% if sections %}
                    {% for section in sections %}
                        <li id="available-section-{{ section.sectionID }}">
                            <span>{{ section.courseID }} - {{ section.course_name }}</span>
                            <span>{{ section.prof_name }}</span>
                            <span>{{ section.time_start }} - {{ section.time_end }}</span>
                            <span>{{ section.dates }}</span>
                            <button class="enroll-button" onclick="enrollInSection('{{ section.sectionID }}')">Enroll</button>
                        </li>
                    {% endfor %}
                {% else %}
                    <li>No sections found matching your criteria.</li>
                {% endif %}
            </ul>
        </div>

        <div class="enrolled-list">
            <h2>Enrolled Sections</h2>
            <ul id="enrolled-sections-list">
                {% if schedule %}
                    {% for enrolled_section in schedule %}
                        <li class="enrolled-section" id="enrolled-section-{{ enrolled_section.sectionID }}">
                            <span>{{ enrolled_section.courseID }} - {{ enrolled_section.course_name }}</span>
                            <span>{{ enrolled_section.prof_name }}</span>
                            <span>{{ enrolled_section.time_start }} - {{ enrolled_section.time_end }}</span>
                             <span>{{ enrolled_section.dates }}</span>
                            <button class="drop-button" onclick="dropSection('{{ enrolled_section.sectionID }}')">Drop</button>
                        </li>
                    {% endfor %}
                {% else %}
                    <li>No enrolled sections.</li>
                {% endif %}
            </ul>
        </div>
    </main>

    <script>
        // days and hours grid
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const hours = Array.from({ length: 15 }, (_, i) => i + 7);

        const schedule = {{ schedule|tojson }};

        function normalizeSchedule(scheduleData) {
            return scheduleData.map(e => {
                const startHour = parseInt(e.time_start.split(":")[0]);
                const endHour = parseInt(e.time_end.split(":")[0]);
                let dayIndex;
                try {
                    dayIndex = days.indexOf(days[new Date(e.dates).getDay() - 1]);
                } catch (error) {
                    dayIndex = -1;
                }
                return {
                    day: days[new Date(e.dates).getDay() - 1],
                    time: startHour,
                    duration: endHour - startHour,
                    title: `${e.courseID}: ${e.course_name}`,
                    sectionId: e.sectionID  // Include sectionId for drop
                };
            });
        }
        const events = normalizeSchedule(schedule);


        const calendar = document.getElementById("calendar");
        const enrolledSectionsList = document.getElementById("enrolled-sections-list");


        function renderCalendar() {
            calendar.innerHTML = "";
            calendar.appendChild(document.createElement("div"));

            days.forEach(d => {
                const div = document.createElement("div");
                div.className = "day-header";
                div.textContent = d;
                calendar.appendChild(div);
            });

            hours.forEach((h, i) => {
                const label = document.createElement("div");
                label.className = "time-label";
                label.textContent = `${h % 12 || 12}${h < 12 ? "AM" : "PM"}`;
                label.style.gridRow = i + 2;
                label.style.gridColumn = 1;
                calendar.appendChild(label);

                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement("div");
                    cell.className = "cell";
                    cell.style.gridRow = i + 2;
                    cell.style.gridColumn = j + 2;
                    calendar.appendChild(cell);
                }
            });

            events.forEach(ev => {
                const dayIndex = days.indexOf(ev.day);
                if (dayIndex < 0) return;
                const startRow = ev.time - 5;
                const endRow = startRow + ev.duration;

                const div = document.createElement("div");
                div.className = "event";
                div.textContent = ev.title;
                div.style.gridColumn = dayIndex + 2;
                div.style.gridRow = `${startRow} / ${endRow}`;
                calendar.appendChild(div);
            });
        }


        function updateEnrolledList(enrolled) {
            enrolledSectionsList.innerHTML = ''; // Clear the list
            if (enrolled.length === 0) {
                enrolledSectionsList.innerHTML = '<li>No enrolled sections.</li>';
                return;
            }
            enrolled.forEach(section => {
                const li = document.createElement("li");
                li.className = "enrolled-section";
                li.id = `enrolled-section-${section.sectionID}`;
                li.innerHTML = `
                    <span>${section.courseID} - ${section.course_name}</span>
                    <span>${section.prof_name}</span>
                    <span>${section.time_start} - ${section.time_end}</span>
                    <span>${section.dates}</span>
                    <button class="drop-button" onclick="dropSection('${section.sectionID}')">Drop</button>
                `;
                enrolledSectionsList.appendChild(li);
            });
            renderCalendar();
        }

        renderCalendar();
        updateEnrolledList(normalizeSchedule(schedule));


        function enrollInSection(sectionId) {
            console.log(`Enrolling in section: ${sectionId}`);

            fetch('/enroll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sectionID: sectionId }), // Corrected key name to sectionID
            })
            .then(response => {
                if (response.ok) {
                    console.log('Successfully enrolled');
                    return response.json(); // Parse JSON to get the updated schedule
                } else if (response.status === 409) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Enrollment failed due to conflict.');
                    });
                }
                 else {
                    throw new Error('Failed to enroll in section.');
                }
            })
            .then(data => {
                // Update the enrolled sections list and calendar
                fetch('/schedule')
                    .then(response => response.json())
                    .then(scheduleData => {
                        const normalizedSchedule = normalizeSchedule(scheduleData.schedule);
                        updateEnrolledList(normalizedSchedule);
                        renderCalendar();
                        // Remove the section from the available sections list
                        const enrolledSectionElement = document.getElementById(`available-section-${sectionId}`);
                        if (enrolledSectionElement) {
                            enrolledSectionElement.remove();
                        }
                    })
                    .catch(err => {
                         console.error("Error fetching updated schedule", err);
                         alert("Error updating schedule. Please refresh the page.");
                    })

            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }

        function dropSection(sectionId) {
            console.log(`Dropping section: ${sectionId}`);
            fetch('/drop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sectionID: sectionId }), // Corrected key name to sectionID
            })
            .then(response => {
                if (response.ok) {
                    console.log('Successfully dropped');
                    return response.json();
                } else {
                    throw new Error('Failed to drop section.');
                }
            })
             .then(data => {
                // Refresh the schedule after dropping
                fetch('/schedule')
                    .then(response => response.json())
                    .then(scheduleData => {
                        const normalizedSchedule = normalizeSchedule(scheduleData.schedule);
                        updateEnrolledList(normalizedSchedule);
                        renderCalendar();
                         // Add the section back to the available sections list (basic approach)
                        //  A more robust approach would involve re-fetching the available sections
                        //  from the server, potentially with updated filters.
                        window.location.reload();

                    })
                    .catch(err => {
                         console.error("Error fetching updated schedule", err);
                         alert("Error updating schedule. Please refresh the page.");
                    })

            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }
    </script>
</body>
</html>
